<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ£ç»ç›´é“æ•™ä¼š - å‡ºå¸­ç»Ÿè®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .service-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: #3498db;
            color: white;
        }

        .tab-button:hover {
            background: #2980b9;
            color: white;
        }

        .service-section {
            display: none;
        }

        .service-section.active {
            display: block;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto auto;
            gap: 15px;
            margin-bottom: 25px;
            align-items: end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group select, .input-group input {
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group select:focus, .input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            height: fit-content;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            margin: 0 10px;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .member-selector {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #ecf0f1;
        }

        .member-selector h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background: white;
        }

        .member-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .member-checkbox:hover {
            background: #f1f2f6;
        }

        .member-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .member-checkbox label {
            cursor: pointer;
            font-size: 0.95em;
            flex: 1;
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .group-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        .group-card:hover {
            transform: translateY(-5px);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .group-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
        }

        .group-count {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .members-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .member-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .attendance-summary {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .date-display {
            background: #34495e;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: inline-block;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .groups-container {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .members-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ åœ£ç»ç›´é“æ•™ä¼šå‡ºå¸­ç»Ÿè®¡</h1>
            <p>å‘¨äº”å’Œå‘¨æ—¥èšä¼šå‡ºå¸­è¿½è¸ªç³»ç»Ÿ</p>
        </div>

        <div class="main-content">
            <div class="service-tabs">
                <button class="tab-button active" onclick="switchService('friday')">å‘¨äº”èšä¼š</button>
                <button class="tab-button" onclick="switchService('sunday')">å‘¨æ—¥èšä¼š</button>
            </div>

            <div id="friday-service" class="service-section active">
                <div class="date-display" id="friday-date"></div>
                
                <div class="attendance-summary">
                    <h3>å‘¨äº”èšä¼šç»Ÿè®¡</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="friday-total-count">0</span>
                            <span class="stat-label">æ€»å‡ºå¸­äººæ•°</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="friday-groups-count">0</span>
                            <span class="stat-label">å‚ä¸å°ç»„æ•°</span>
                        </div>
                    </div>
                </div>

                <div class="member-selector">
                    <h3>é€‰æ‹©å‡ºå¸­æˆå‘˜ (æŒ‰å°ç»„)</h3>
                    <div class="controls">
                        <div class="input-group">
                            <label for="friday-group-select">é€‰æ‹©å°ç»„</label>
                            <select id="friday-group-select" onchange="loadGroupMembers('friday')">
                                <option value="">é€‰æ‹©å°ç»„...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="friday-custom-member">æˆ–æ·»åŠ æ–°äºº</label>
                            <input type="text" id="friday-custom-member" placeholder="è¾“å…¥æ–°äººå§“å">
                        </div>
                        <button class="btn btn-secondary" onclick="addCustomMember('friday')">æ·»åŠ æ–°äºº</button>
                        <button class="btn btn-primary" onclick="clearSelection('friday')">æ¸…ç©ºé€‰æ‹©</button>
                    </div>
                    
                    <div id="friday-members-grid" class="members-grid" style="display: none;"></div>
                    
                    <div class="bulk-actions">
                        <button class="btn btn-success" onclick="markSelectedPresent('friday')">æ ‡è®°é€‰ä¸­ä¸ºå‡ºå¸­</button>
                        <button class="btn btn-secondary" onclick="selectAllGroup('friday')">å…¨é€‰å½“å‰å°ç»„</button>
                        <button class="btn btn-primary" onclick="showAddNewMemberModal('friday')">æ·»åŠ æ–°æˆå‘˜åˆ°å°ç»„</button>
                    </div>
                </div>

                <div id="friday-groups" class="groups-container"></div>
            </div>

            <div id="sunday-service" class="service-section">
                <div class="date-display" id="sunday-date"></div>
                
                <div class="attendance-summary">
                    <h3>å‘¨æ—¥èšä¼šç»Ÿè®¡</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="sunday-total-count">0</span>
                            <span class="stat-label">æ€»å‡ºå¸­äººæ•°</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="sunday-groups-count">0</span>
                            <span class="stat-label">å‚ä¸å°ç»„æ•°</span>
                        </div>
                    </div>
                </div>

                <div class="member-selector">
                    <h3>é€‰æ‹©å‡ºå¸­æˆå‘˜ (æŒ‰å°ç»„)</h3>
                    <div class="controls">
                        <div class="input-group">
                            <label for="sunday-group-select">é€‰æ‹©å°ç»„</label>
                            <select id="sunday-group-select" onchange="loadGroupMembers('sunday')">
                                <option value="">é€‰æ‹©å°ç»„...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="sunday-custom-member">æˆ–æ·»åŠ æ–°äºº</label>
                            <input type="text" id="sunday-custom-member" placeholder="è¾“å…¥æ–°äººå§“å">
                        </div>
                        <button class="btn btn-secondary" onclick="addCustomMember('sunday')">æ·»åŠ æ–°äºº</button>
                        <button class="btn btn-primary" onclick="clearSelection('sunday')">æ¸…ç©ºé€‰æ‹©</button>
                    </div>
                    
                    <div id="sunday-members-grid" class="members-grid" style="display: none;"></div>
                    
                    <div class="bulk-actions">
                        <button class="btn btn-success" onclick="markSelectedPresent('sunday')">æ ‡è®°é€‰ä¸­ä¸ºå‡ºå¸­</button>
                        <button class="btn btn-secondary" onclick="selectAllGroup('sunday')">å…¨é€‰å½“å‰å°ç»„</button>
                        <button class="btn btn-primary" onclick="showAddNewMemberModal('sunday')">æ·»åŠ æ–°æˆå‘˜åˆ°å°ç»„</button>
                    </div>
                </div>

                <div id="sunday-groups" class="groups-container"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="exportData()">ğŸ“Š å¯¼å‡ºå‡ºå¸­æ•°æ®</button>
                <button class="btn btn-primary" onclick="emailAttendanceReport()">ğŸ“§ ç”Ÿæˆé‚®ä»¶æŠ¥å‘Š</button>
                <button class="btn btn-secondary" onclick="copyReportToClipboard()" style="margin-left: 10px;">ğŸ“‹ å¤åˆ¶æŠ¥å‘Š</button>
            </div>
        </div>
    </div>

    <!-- Add New Member Modal -->
    <div id="newMemberModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">æ·»åŠ æ–°æˆå‘˜åˆ°å°ç»„</h3>
            
            <div class="input-group" style="margin-bottom: 15px;">
                <label for="newMemberName">æˆå‘˜å§“å</label>
                <input type="text" id="newMemberName" placeholder="è¾“å…¥æ–°æˆå‘˜å§“å" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
            </div>
            
            <div class="input-group" style="margin-bottom: 20px;">
                <label for="newMemberGroup">é€‰æ‹©å°ç»„</label>
                <select id="newMemberGroup" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 8px;">
                    <option value="">é€‰æ‹©å°ç»„...</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeAddNewMemberModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addNewMemberToGroup()">æ·»åŠ æˆå‘˜</button>
            </div>
        </div>
    </div>

    <script>
        // Church member data from Excel file
        const churchMembers = {
            "å–œä¹": ["è¬å­å…‰", "ç‹ç‘‹", "ç‹è¼”ä»", "é¾ç§€è˜­", "ç‹å¥", "èƒ¡å¹¼éˆ", "æ²ˆåœ‹å¿ ", "è”¡ç«‹ç«‹", "é¢œç¾ç", "é»å°å®¹", "é‡‘é¡¯å¾·", "èŠè", "ç››è¯éŒš"],
            "å¹³å®‰": ["ç‹é›¯ç‘›", "æ­å¿ ç”·", "æ­æ¥Šä½æƒ ", "æ¢å¯°", "Wendy", "å¾ çŠ", "æœ±å¤§ç™½", "é™ˆå¹³ä¸€", "å¾çˆ±å…¨", "é½Šæ²»å¹³", "ç‹åª›ç³", "ç‹è˜‹å¨Ÿ", "ç²±å®“", "ä¿å¨è¯", "æéœèŠ³", "ç‹ç‘æ ‹", "ç‹å”¯ä¸­", "å‘¨ç«‹è¯"],
            "æ©æ…ˆ": ["æé¼æ°‘", "ç‹ç¾å…ƒ", "æç‹è‡´æ•", "æ¸¸åœ‹çƒŠ", "æ±ªç»®æ•", "æ±ªå˜‰æŒ¯", "æœ±ç§€è´Jane", "æè¨±éŸ»è˜‡", "é™³éœ²å¾·", "é™³æ‹‰çµ", "æ²ˆé€¸çŠ", "ç‹ç¾å¯¶", "èƒ¡ç„¯æ˜", "Danielé™ˆ", "å‘¨é›ªè‹±", "Tracy è´¾", "ç‹æ²›ä¿®", "å¾ç¦æ–‡", "Lily Chang", "Avery Peng å½­"],
            "æ´»æ°´": ["è™ä¸€å³°", "é‚“æ»”", "ç‹éŸ¶è¼", "è¬é›¯è‰", "å¢ç²", "èµµè”èƒœ", "è¨±è¶…", "Alvin", "éƒ­æ¹˜å¯§", "ç‹è»", "Harry Wu", "é¦¬æ˜¥", "å¼µæ›‰æ˜¥", "ç‹æ›‰å©·", "ç‹å®šå®¶/äº‘ç”Ÿ", "åˆ˜ä¸¹", "æ¨æ˜å³°", "è‰¾ç³", "è˜‡ç‡•è", "å³é«˜ç¿”", "ç‹ç­±ç’Vivian", "Jay", "æœç", "å¼µä¸­ç”Ÿ", "æå°‘èŠ³", "ç‹æ°´æœ¨", "ç‰è£", "æ¨ç³", "å´ Serena", "ç‹ä¾ç‘¤", "è£´äº‘", "å¾ç§€ç´", "ç¿æ›‰ç´…", "Jennifer", "è‹è–‡è–‡", "ææ˜¥æµ©", "å½­ä¸½", "é™³ç«è™¹"],
            "æ©æƒ ": ["å¾å´‡é›·", "å—æ¦®èŠ³", "å­”åº†é¢–", "ç‹å…†ç¥¥", "é‡‘æ¢…", "ä»˜ä¸¹ä¸¹", "å®‹ç«‹å±±", "éƒ­å‘ä¸œ", "åŠ‰ç‘¤", "ç†Šæ¶›Vivian", "å•æ•", "Tina Xie", "å°¹æ›‰æ¦®", "ä½•å¥", "æˆ´æ–¹", "æç¾¤", "Lilian", "å‘¨è³½è", "åŠ‰å°ç¾", "ã‘è•Š", "æ¢é›ªç²", "é€£å…ˆç”Ÿ", "è¾›å°é¾™", "ææ¡‚å…°", "æ¢æ°¸èŠ³", "æœ±æ¨¹ç‘¾", "å¸é›™è¦‹", "Chris", "ç‹å¦ˆå¦ˆ", "æ±Ÿ é»", "é»æ•", "Shirley Lee", "å¼ è‹±ä¿ŠJean", "å‡Œè³´ç¾…ç¶º", "é¡¾ç‚³ç¥", "åˆ˜é”¦èŠ¸"],
            "é¦™æŸæ¨¹": ["å¸ƒç§€è‹±", "éƒ­èŠè‹±", "éŠ­é‡‘å¨£", "æ›¹é³³å¨¥", "è‘›å­è", "æ›¹ä½©ç", "è¬æ„›å§º", "ç‹ç§€å…°", "æˆ´æ·‘å¤", "é™†ç¾è‹±"],
            "é’æ©„æ¬–": ["å¼ å“²åƒ", "å­Ÿç¹æµ©", "é¦®é»äºˆ", "æ¸¸å®¶ç®", "å²å¤¢äº­", "ç« æ–‡å¸", "åŸè¶…", "æåœ†æ±", "æœäº¨è£", "è¶™å¿", "é™³æ–‡å³°", "Eric", "Laura", "å¼ æ€å¦", "æ²ˆè¾°è¾°", "Derek", "Grace", "Sean", "Precilia", "ä½™èŠ·æ•", "å´æµ©ç„¶", "å”å“²æ£®", "å­™æ„", "å•æ˜Šå", "Kei", "ææ¢“ç‘¶", "Gelvin", "æé¬ç„¶", "å´å“ä¸€", "é¡¾è¾¾ç»´David", "é¡¾åˆ©äºš"],
            "ç‰§è€…": ["è¶™ç‰§å¸«", "è¶™å¸«æ¯", "é™³æ¨¹æ°‘é•·è€", "æƒ ç²å¸«æ¯", "é—«å²©ä¼ é“", "æä½©çŠ", "å‡Œå¿—é¹ç‰§å¸«", "é„­éš†ä¿ç‰§å¸«", "é»ƒéŒ¦è¯", "é»ƒè²´ç", "è¶™å­åˆç‰§å¸«", "åŠ‰å¯Œç†ç‰§å¸«", "é»„æ˜é®ç‰§å¸ˆ", "èŠæ³½è±Šç‰§å¸ˆ", "è”¡æ­£é©Šç‰§å¸«", "æå‰æ˜ç‰§å¸ˆ", "å‘¨æ™¯å‡ç‰§å¸ˆå¸ˆæ¯", "åŠ‰å°‘å¹³ç‰§å¸«å¸ˆæ¯", "è•­å®éµ¬ç‰§å¸«å¸«æ¯", "è”¡è€€æ˜", "å»–æ„›è¯", "é‚±èŒ‚æ¾ç‰§å¸«", "ä½•å´‡ç¦§ç‰§å¸«å¸«æ¯", "ç‹è‰¯å¿ ç‰§å¸«å¸«æ¯", "åˆ˜ä¿Šå®‰ç‰§å¸ˆå¸ˆæ¯", "å•æ•", "éƒ­ä¸œç»ªç‰§å¸ˆå¸ˆæ¯", "å¶ä¿Šæ˜ç‰§å¸ˆ", "é‚µæ™¨å…‰ç‰§å¸ˆ", "Matt Doan", "Eric", "ç›§æ†ç‰§å¸ˆ", "åˆ˜å­å‹‡é™¢é•¿"]
        };

        // Data storage
        let attendanceData = {
            friday: {},
            sunday: {}
        };

        // Email configuration
        const EMAIL_CONFIG = {
            targetEmail: 'kzhao8@gmail.com'
        };

        // Initialize the app
        function init() {
            updateDateDisplays();
            loadMemberDatabase(); // Load any new members added previously
            populateGroupSelectors();
            loadData();
            updateStats('friday');
            updateStats('sunday');
            
            console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ - ä½¿ç”¨å†…ç½®é‚®ä»¶åŠŸèƒ½');
            console.log('ç›®æ ‡é‚®ç®±:', EMAIL_CONFIG.targetEmail);
        }

        // Update date displays
        function updateDateDisplays() {
            const now = new Date();
            
            // Find next Friday
            const nextFriday = new Date();
            nextFriday.setDate(now.getDate() + (5 - now.getDay() + 7) % 7);
            if (now.getDay() === 5) nextFriday.setDate(now.getDate());
            
            // Find next Sunday
            const nextSunday = new Date();
            nextSunday.setDate(now.getDate() + (7 - now.getDay()) % 7);
            if (now.getDay() === 0) nextSunday.setDate(now.getDate());
            
            document.getElementById('friday-date').textContent = 
                `å‘¨äº”èšä¼š - ${nextFriday.toLocaleDateString('zh-CN')}`;
            document.getElementById('sunday-date').textContent = 
                `å‘¨æ—¥èšä¼š - ${nextSunday.toLocaleDateString('zh-CN')}`;
        }

        // Populate group selector dropdowns
        function populateGroupSelectors() {
            const groupNames = Object.keys(churchMembers);
            
            ['friday', 'sunday'].forEach(service => {
                const selector = document.getElementById(`${service}-group-select`);
                selector.innerHTML = '<option value="">é€‰æ‹©å°ç»„...</option>';
                
                groupNames.forEach(groupName => {
                    const option = document.createElement('option');
                    option.value = groupName;
                    option.textContent = `${groupName} (${churchMembers[groupName].length}äºº)`;
                    selector.appendChild(option);
                });
            });
        }

        // Load group members for selection
        function loadGroupMembers(service) {
            const groupSelect = document.getElementById(`${service}-group-select`);
            const membersGrid = document.getElementById(`${service}-members-grid`);
            const selectedGroup = groupSelect.value;

            if (!selectedGroup) {
                membersGrid.style.display = 'none';
                return;
            }

            const members = churchMembers[selectedGroup];
            membersGrid.innerHTML = '';
            membersGrid.style.display = 'grid';

            members.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-checkbox';
                
                const memberId = `${service}-${selectedGroup}-${member}`.replace(/[^a-zA-Z0-9]/g, '');
                
                memberDiv.innerHTML = `
                    <input type="checkbox" id="${memberId}" value="${member}">
                    <label for="${memberId}">${member}</label>
                `;
                
                membersGrid.appendChild(memberDiv);
            });
        }

        // Switch between services
        function switchService(service) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update service sections
            document.querySelectorAll('.service-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${service}-service`).classList.add('active');
        }

        // Mark selected members as present
        function markSelectedPresent(service) {
            const groupSelect = document.getElementById(`${service}-group-select`);
            const selectedGroup = groupSelect.value;
            
            if (!selectedGroup) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå°ç»„');
                return;
            }

            const membersGrid = document.getElementById(`${service}-members-grid`);
            const checkboxes = membersGrid.querySelectorAll('input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€åæˆå‘˜');
                return;
            }

            // Initialize group if it doesn't exist
            if (!attendanceData[service][selectedGroup]) {
                attendanceData[service][selectedGroup] = [];
            }

            let addedCount = 0;
            checkboxes.forEach(checkbox => {
                const memberName = checkbox.value;
                if (!attendanceData[service][selectedGroup].includes(memberName)) {
                    attendanceData[service][selectedGroup].push(memberName);
                    addedCount++;
                }
                checkbox.checked = false;
            });

            if (addedCount > 0) {
                renderGroups(service);
                updateStats(service);
                saveData();
                alert(`æˆåŠŸæ·»åŠ  ${addedCount} åæˆå‘˜åˆ°å‡ºå¸­åå•`);
            } else {
                alert('é€‰ä¸­çš„æˆå‘˜å·²åœ¨å‡ºå¸­åå•ä¸­');
            }
        }

        // Select all members in current group
        function selectAllGroup(service) {
            const membersGrid = document.getElementById(`${service}-members-grid`);
            const checkboxes = membersGrid.querySelectorAll('input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        // Clear all selections
        function clearSelection(service) {
            const membersGrid = document.getElementById(`${service}-members-grid`);
            const checkboxes = membersGrid.querySelectorAll('input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Add custom member (new person)
        function addCustomMember(service) {
            const input = document.getElementById(`${service}-custom-member`);
            const memberName = input.value.trim();
            
            if (!memberName) {
                alert('è¯·è¾“å…¥æ–°äººå§“å');
                return;
            }

            const newPersonGroup = 'æ–°äºº';
            
            // Initialize new person group if it doesn't exist
            if (!attendanceData[service][newPersonGroup]) {
                attendanceData[service][newPersonGroup] = [];
            }

            // Check if member already exists
            if (attendanceData[service][newPersonGroup].includes(memberName)) {
                alert('è¯¥æ–°äººå·²åœ¨å‡ºå¸­åå•ä¸­');
                return;
            }

            // Add new person
            attendanceData[service][newPersonGroup].push(memberName);
            
            // Clear input
            input.value = '';
            
            // Update display
            renderGroups(service);
            updateStats(service);
            saveData();
            
            alert(`æ–°äºº ${memberName} å·²æ·»åŠ åˆ°å‡ºå¸­åå•`);
        }

        // Show add new member modal
        function showAddNewMemberModal(service) {
            const modal = document.getElementById('newMemberModal');
            const groupSelect = document.getElementById('newMemberGroup');
            
            // Clear previous values
            document.getElementById('newMemberName').value = '';
            groupSelect.innerHTML = '<option value="">é€‰æ‹©å°ç»„...</option>';
            
            // Populate group options
            Object.keys(churchMembers).forEach(groupName => {
                const option = document.createElement('option');
                option.value = groupName;
                option.textContent = `${groupName} (${churchMembers[groupName].length}äºº)`;
                groupSelect.appendChild(option);
            });
            
            // Store current service for later use
            modal.dataset.service = service;
            modal.style.display = 'flex';
        }

        // Close add new member modal
        function closeAddNewMemberModal() {
            document.getElementById('newMemberModal').style.display = 'none';
        }

        // Add new member to church group
        function addNewMemberToGroup() {
            const modal = document.getElementById('newMemberModal');
            const memberName = document.getElementById('newMemberName').value.trim();
            const groupName = document.getElementById('newMemberGroup').value;
            
            if (!memberName || !groupName) {
                alert('è¯·è¾“å…¥æˆå‘˜å§“åå¹¶é€‰æ‹©å°ç»„');
                return;
            }

            // Check if member already exists in the group
            if (churchMembers[groupName].includes(memberName)) {
                alert('è¯¥æˆå‘˜å·²å­˜åœ¨äºæ­¤å°ç»„ä¸­');
                return;
            }

            // Add member to church database
            churchMembers[groupName].push(memberName);
            
            // Refresh group selectors
            populateGroupSelectors();
            
            // If current group is selected, refresh member grid
            const service = modal.dataset.service;
            const currentGroupSelect = document.getElementById(`${service}-group-select`);
            if (currentGroupSelect.value === groupName) {
                loadGroupMembers(service);
            }
            
            // Close modal
            closeAddNewMemberModal();
            
            // Save updated member database
            saveMemberDatabase();
            
            alert(`æˆå‘˜ ${memberName} å·²æˆåŠŸæ·»åŠ åˆ° ${groupName} å°ç»„`);
        }

        // Save member database to localStorage
        function saveMemberDatabase() {
            const data = JSON.stringify(churchMembers);
            localStorage.setItem('churchMembersDatabase', data);
        }

        // Generate and open email report (using mailto)
        function emailAttendanceReport() {
            console.log('ç”Ÿæˆé‚®ä»¶æŠ¥å‘Š...');
            
            const now = new Date();
            const reportData = generateAttendanceReport();
            
            // Check if there's any attendance data
            if (reportData.friday.totalMembers === 0 && reportData.sunday.totalMembers === 0) {
                alert('âš ï¸ æ²¡æœ‰å‡ºå¸­æ•°æ®å¯å‘é€ã€‚è¯·å…ˆæ·»åŠ ä¸€äº›å‡ºå¸­è®°å½•ã€‚');
                return;
            }
            
            // Format email content
            const subject = encodeURIComponent(`åœ£ç»ç›´é“æ•™ä¼šå‡ºå¸­æŠ¥å‘Š - ${now.toLocaleDateString('zh-CN')}`);
            const body = encodeURIComponent(formatEmailMessage(reportData));
            
            // Create mailto link
            const mailtoLink = `mailto:${EMAIL_CONFIG.targetEmail}?subject=${subject}&body=${body}`;
            
            // Check if mailto link is too long (some email clients have limits)
            if (mailtoLink.length > 2000) {
                alert('ğŸ“§ æŠ¥å‘Šå†…å®¹è¾ƒé•¿ï¼Œå°†ä½¿ç”¨å¤åˆ¶æ–¹å¼\n\nç‚¹å‡»"ç¡®å®š"åæŠ¥å‘Šå°†å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨ç²˜è´´åˆ°é‚®ä»¶ä¸­ã€‚');
                copyReportToClipboard();
                return;
            }
            
            // Try to open default email client
            try {
                window.location.href = mailtoLink;
                alert('âœ… å·²æ‰“å¼€é»˜è®¤é‚®ä»¶å®¢æˆ·ç«¯\n\n' + 
                      'æ”¶ä»¶äºº: ' + EMAIL_CONFIG.targetEmail + '\n' +
                      'å¦‚æœé‚®ä»¶å®¢æˆ·ç«¯æ²¡æœ‰æ‰“å¼€ï¼Œè¯·ç‚¹å‡»"å¤åˆ¶æŠ¥å‘Š"æŒ‰é’®æ‰‹åŠ¨å‘é€ã€‚');
            } catch (error) {
                console.error('æ— æ³•æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯:', error);
                alert('âŒ æ— æ³•æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯\n\nå°†ä¸ºæ‚¨å¤åˆ¶æŠ¥å‘Šå†…å®¹ï¼Œè¯·æ‰‹åŠ¨å‘é€é‚®ä»¶ã€‚');
                copyReportToClipboard();
            }
        }

        // Copy report to clipboard
        function copyReportToClipboard() {
            const reportData = generateAttendanceReport();
            const reportText = formatEmailMessage(reportData);
            
            // Try to copy to clipboard
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(reportText).then(() => {
                    alert('âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' +
                          'è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å‘é€é‚®ä»¶ï¼š\n' +
                          '1. æ‰“å¼€æ‚¨çš„é‚®ä»¶å®¢æˆ·ç«¯\n' +
                          '2. æ–°å»ºé‚®ä»¶ç»™ï¼š' + EMAIL_CONFIG.targetEmail + '\n' +
                          '3. ç²˜è´´æŠ¥å‘Šå†…å®¹ (Ctrl+V)\n' +
                          '4. å‘é€é‚®ä»¶');
                }).catch(err => {
                    fallbackCopyMethod(reportText);
                });
            } else {
                fallbackCopyMethod(reportText);
            }
        }

        // Fallback copy method for older browsers
        function fallbackCopyMethod(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' +
                      'è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å‘é€é‚®ä»¶ï¼š\n' +
                      '1. æ‰“å¼€æ‚¨çš„é‚®ä»¶å®¢æˆ·ç«¯\n' +
                      '2. æ–°å»ºé‚®ä»¶ç»™ï¼š' + EMAIL_CONFIG.targetEmail + '\n' +
                      '3. ç²˜è´´æŠ¥å‘Šå†…å®¹ (Ctrl+V)\n' +
                      '4. å‘é€é‚®ä»¶');
            } catch (err) {
                // Show the text in a dialog if all else fails
                const message = 'æ— æ³•è‡ªåŠ¨å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹å‘é€ç»™ï¼š' + EMAIL_CONFIG.targetEmail + '\n\n' + text;
                
                // Create a modal to show the text
                showReportModal(text);
            }
            
            document.body.removeChild(textArea);
        }

        // Show report in a modal for manual copying
        function showReportModal(reportText) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 2000; 
                display: flex; justify-content: center; align-items: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 80%; max-height: 80%; overflow: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #2c3e50;">å‡ºå¸­æŠ¥å‘Š - è¯·æ‰‹åŠ¨å¤åˆ¶</h3>
                <p style="margin-bottom: 15px; color: #7f8c8d;">
                    å‘é€ç»™: <strong>${EMAIL_CONFIG.targetEmail}</strong>
                </p>
                <textarea readonly style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 12px;">${reportText}</textarea>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Select all text in textarea
            const textarea = content.querySelector('textarea');
            textarea.focus();
            textarea.select();
        }

        // Generate attendance report data
        function generateAttendanceReport() {
            return {
                exportDate: new Date().toISOString(),
                church: 'åœ£ç»ç›´é“æ•™ä¼š',
                friday: {
                    totalMembers: Object.values(attendanceData.friday).reduce((sum, members) => sum + members.length, 0),
                    totalGroups: Object.keys(attendanceData.friday).length,
                    groups: Object.keys(attendanceData.friday).map(groupName => ({
                        name: groupName,
                        count: attendanceData.friday[groupName].length,
                        members: attendanceData.friday[groupName]
                    }))
                },
                sunday: {
                    totalMembers: Object.values(attendanceData.sunday).reduce((sum, members) => sum + members.length, 0),
                    totalGroups: Object.keys(attendanceData.sunday).length,
                    groups: Object.keys(attendanceData.sunday).map(groupName => ({
                        name: groupName,
                        count: attendanceData.sunday[groupName].length,
                        members: attendanceData.sunday[groupName]
                    }))
                }
            };
        }

        // Format attendance data for email
        function formatAttendanceForEmail(groups) {
            if (groups.length === 0) return 'æ— å‡ºå¸­è®°å½•';
            
            return groups.map(group => 
                `${group.name} (${group.count}äºº): ${group.members.join(', ')}`
            ).join('\n');
        }

        // Format complete email message
        function formatEmailMessage(reportData) {
            const now = new Date();
            let message = `åœ£ç»ç›´é“æ•™ä¼šå‡ºå¸­æŠ¥å‘Š\n`;
            message += `æŠ¥å‘Šæ—¥æœŸ: ${now.toLocaleDateString('zh-CN')} ${now.toLocaleTimeString('zh-CN')}\n\n`;
            
            message += `ğŸ“Š æ€»ä½“ç»Ÿè®¡:\n`;
            message += `å‘¨äº”èšä¼š: ${reportData.friday.totalMembers}äººå‡ºå¸­ (${reportData.friday.totalGroups}ä¸ªå°ç»„)\n`;
            message += `å‘¨æ—¥èšä¼š: ${reportData.sunday.totalMembers}äººå‡ºå¸­ (${reportData.sunday.totalGroups}ä¸ªå°ç»„)\n\n`;
            
            if (reportData.friday.totalMembers > 0) {
                message += `ğŸ™ å‘¨äº”èšä¼šè¯¦æƒ…:\n`;
                message += formatAttendanceForEmail(reportData.friday.groups) + '\n\n';
            }
            
            if (reportData.sunday.totalMembers > 0) {
                message += `â›ª å‘¨æ—¥èšä¼šè¯¦æƒ…:\n`;
                message += formatAttendanceForEmail(reportData.sunday.groups) + '\n\n';
            }
            
            message += `---\næ­¤æŠ¥å‘Šç”±åœ£ç»ç›´é“æ•™ä¼šå‡ºå¸­ç»Ÿè®¡ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ`;
            
            return message;
        }

        // Show email setup instructions
        function showEmailSetupInstructions() {
            const instructions = `
ğŸ“§ é‚®ä»¶åŠŸèƒ½ä½¿ç”¨è¯´æ˜ï¼š

ç”±äºç½‘ç»œé™åˆ¶ï¼Œå·²åˆ‡æ¢ä¸ºæœ¬åœ°é‚®ä»¶åŠŸèƒ½

ğŸ¯ ä½¿ç”¨æ–¹æ³•ï¼š
1. æ·»åŠ å‡ºå¸­æ•°æ®
2. ç‚¹å‡»"ç”Ÿæˆé‚®ä»¶æŠ¥å‘Š"
3. ç³»ç»Ÿå°†è‡ªåŠ¨æ‰“å¼€é»˜è®¤é‚®ä»¶å®¢æˆ·ç«¯
4. æˆ–ä½¿ç”¨"å¤åˆ¶æŠ¥å‘Š"æ‰‹åŠ¨å‘é€

ğŸ“‹ å¤‡é€‰æ–¹æ¡ˆï¼š
â€¢ å¤åˆ¶æŠ¥å‘Šå†…å®¹
â€¢ æ‰‹åŠ¨ç²˜è´´åˆ°é‚®ä»¶ä¸­
â€¢ å‘é€ç»™ï¼š${EMAIL_CONFIG.targetEmail}

âœ… åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼Œåªæ˜¯å‘é€æ–¹å¼æœ‰æ‰€è°ƒæ•´
            `;
            
            alert(instructions);
        }
        function showEmailSetupInstructions() {
            const instructions = `
ğŸ“§ é‚®ä»¶åŠŸèƒ½é…ç½®çŠ¶æ€ï¼š

âœ… å·²å®Œæˆæ‰€æœ‰é…ç½®ï¼š
- Service ID: service_5m5lyfs
- Template ID: template_nz6rhqq  
- Public Key: -g4LYh8HZH3_tnI2O
- ç›®æ ‡é‚®ç®±: kzhao8@gmail.com

ğŸ‰ é‚®ä»¶åŠŸèƒ½å·²å°±ç»ªï¼

æ‚¨ç°åœ¨å¯ä»¥ï¼š
1. æ·»åŠ å‡ºå¸­æ•°æ®
2. ç‚¹å‡»"å‘é€ç‚¹åæŠ¥å‘Š"æŒ‰é’®
3. æŠ¥å‘Šå°†è‡ªåŠ¨å‘é€åˆ° kzhao8@gmail.com

ğŸ“§ é‚®ä»¶æ¨¡æ¿å˜é‡è¯´æ˜ï¼š
ç¡®ä¿æ‚¨çš„ EmailJS æ¨¡æ¿ (template_nz6rhqq) åŒ…å«ï¼š
- {{message}} - å®Œæ•´çš„æŠ¥å‘Šå†…å®¹
- {{subject}} - é‚®ä»¶æ ‡é¢˜
- {{from_name}} - å‘é€äººåç§°
- {{to_email}} - æ”¶ä»¶äººé‚®ç®±

å¦‚æœå‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç½‘ç»œè¿æ¥
2. EmailJS æœåŠ¡çŠ¶æ€
3. æ¨¡æ¿é…ç½®æ˜¯å¦æ­£ç¡®
            `;
            
            alert(instructions);
        }
        function loadMemberDatabase() {
            const savedData = localStorage.getItem('churchMembersDatabase');
            if (savedData) {
                const loadedMembers = JSON.parse(savedData);
                // Merge with original data, preserving new additions
                Object.keys(loadedMembers).forEach(groupName => {
                    if (churchMembers[groupName]) {
                        // Add any new members that aren't in the original list
                        loadedMembers[groupName].forEach(member => {
                            if (!churchMembers[groupName].includes(member)) {
                                churchMembers[groupName].push(member);
                            }
                        });
                    }
                });
            }
        }
        function removeMember(service, groupName, memberName) {
            const group = attendanceData[service][groupName];
            const index = group.indexOf(memberName);
            
            if (index > -1) {
                group.splice(index, 1);
                
                // Remove group if empty
                if (group.length === 0) {
                    delete attendanceData[service][groupName];
                }
                
                renderGroups(service);
                updateStats(service);
                saveData();
            }
        }

        // Render groups for a service
        function renderGroups(service) {
            const container = document.getElementById(`${service}-groups`);
            container.innerHTML = '';

            const groups = attendanceData[service];
            
            Object.keys(groups).forEach(groupName => {
                const members = groups[groupName];
                
                const groupCard = document.createElement('div');
                groupCard.className = 'group-card';
                
                groupCard.innerHTML = `
                    <div class="group-header">
                        <div class="group-name">${groupName}</div>
                        <div class="group-count">${members.length}</div>
                    </div>
                    <div class="members-list">
                        ${members.map(member => `
                            <div class="member-item">
                                <span class="member-name">${member}</span>
                                <button class="btn btn-danger" onclick="removeMember('${service}', '${groupName}', '${member}')">ç§»é™¤</button>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(groupCard);
            });
        }

        // Update statistics
        function updateStats(service) {
            const groups = attendanceData[service];
            const totalMembers = Object.values(groups).reduce((sum, members) => sum + members.length, 0);
            const totalGroups = Object.keys(groups).length;

            document.getElementById(`${service}-total-count`).textContent = totalMembers;
            document.getElementById(`${service}-groups-count`).textContent = totalGroups;
        }

        // Save data to localStorage
        function saveData() {
            const data = JSON.stringify(attendanceData);
            localStorage.setItem('churchAttendanceData', data);
        }

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('churchAttendanceData');
            if (savedData) {
                attendanceData = JSON.parse(savedData);
                renderGroups('friday');
                renderGroups('sunday');
            }
        }

        // Export attendance data
        function exportData() {
            const now = new Date();
            const exportData = {
                exportDate: now.toISOString(),
                exportDateChinese: now.toLocaleDateString('zh-CN'),
                church: 'åœ£ç»ç›´é“æ•™ä¼š',
                fridayAttendance: attendanceData.friday,
                sundayAttendance: attendanceData.sunday,
                summary: {
                    friday: {
                        totalMembers: Object.values(attendanceData.friday).reduce((sum, members) => sum + members.length, 0),
                        totalGroups: Object.keys(attendanceData.friday).length,
                        groups: Object.keys(attendanceData.friday).map(groupName => ({
                            name: groupName,
                            count: attendanceData.friday[groupName].length,
                            members: attendanceData.friday[groupName]
                        }))
                    },
                    sunday: {
                        totalMembers: Object.values(attendanceData.sunday).reduce((sum, members) => sum + members.length, 0),
                        totalGroups: Object.keys(attendanceData.sunday).length,
                        groups: Object.keys(attendanceData.sunday).map(groupName => ({
                            name: groupName,
                            count: attendanceData.sunday[groupName].length,
                            members: attendanceData.sunday[groupName]
                        }))
                    }
                },
                totalChurchMembers: Object.values(churchMembers).reduce((sum, members) => sum + members.length, 0),
                totalSmallGroups: Object.keys(churchMembers).length
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `åœ£ç»ç›´é“æ•™ä¼šå‡ºå¸­ç»Ÿè®¡-${now.toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Allow Enter key to add custom members
            ['friday', 'sunday'].forEach(service => {
                const customInput = document.getElementById(`${service}-custom-member`);
                customInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addCustomMember(service);
                    }
                });
            });

            // Allow Enter key in new member modal
            document.getElementById('newMemberName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewMemberToGroup();
                }
            });

            // Close modal when clicking outside
            document.getElementById('newMemberModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAddNewMemberModal();
                }
            });
        });
    </script>
</body>
</html>
